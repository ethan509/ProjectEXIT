openapi: 3.0.3
info:
  title: LottoSmash API
  description: LottoSmash 서버 API 명세
  version: 1.0.0

servers:
  - url: http://localhost:8080
    description: Local development server

tags:
  - name: System
    description: 시스템 상태 확인
  - name: Example
    description: 예제 API
  - name: Auth
    description: 인증 관련 API

paths:
  # ============================================
  # System APIs
  # ============================================
  /healthz:
    get:
      tags: [System]
      summary: 서버 상태 확인
      description: 서버가 살아있는지 확인
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'

  /readyz:
    get:
      tags: [System]
      summary: 서버 준비 상태 확인
      description: 서버가 요청을 처리할 준비가 되었는지 확인
      responses:
        '200':
          description: Ready
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'

  /metrics:
    get:
      tags: [System]
      summary: Prometheus 메트릭
      description: Prometheus 형식의 메트릭 데이터
      responses:
        '200':
          description: Metrics data
          content:
            text/plain:
              schema:
                type: string

  # ============================================
  # Example APIs
  # ============================================
  /api/v1/ping:
    get:
      tags: [Example]
      summary: Ping 테스트
      description: 서버 연결 테스트용 ping
      responses:
        '200':
          description: Pong
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          now:
                            type: string
                            format: date-time

  /api/v1/echo:
    post:
      tags: [Example]
      summary: Echo 테스트
      description: 요청 메시지를 그대로 반환
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [message]
              properties:
                message:
                  type: string
                  example: "Hello, World!"
      responses:
        '200':
          description: Echo response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '503':
          $ref: '#/components/responses/ServiceUnavailable'

  # ============================================
  # Auth APIs (Public)
  # ============================================
  /api/auth/guest:
    post:
      tags: [Auth]
      summary: 게스트 로그인
      description: 디바이스 ID로 게스트 계정 생성 및 로그인
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [device_id]
              properties:
                device_id:
                  type: string
                  example: "device-uuid-1234"
      responses:
        '200':
          description: 로그인 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '400':
          $ref: '#/components/responses/BadRequest'

  /api/auth/register:
    post:
      tags: [Auth]
      summary: 이메일 회원가입
      description: 이메일 인증 후 회원가입
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password, code]
              properties:
                email:
                  type: string
                  format: email
                  example: "user@example.com"
                password:
                  type: string
                  format: password
                  example: "password123"
                code:
                  type: string
                  description: 이메일 인증 코드
                  example: "123456"
      responses:
        '201':
          description: 회원가입 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          description: 이메일 중복
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/auth/login:
    post:
      tags: [Auth]
      summary: 이메일 로그인
      description: 이메일과 비밀번호로 로그인
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email:
                  type: string
                  format: email
                  example: "user@example.com"
                password:
                  type: string
                  format: password
                  example: "password123"
      responses:
        '200':
          description: 로그인 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/auth/refresh:
    post:
      tags: [Auth]
      summary: 토큰 갱신
      description: Refresh token으로 새로운 access token 발급
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [refresh_token]
              properties:
                refresh_token:
                  type: string
                  example: "eyJhbGciOiJIUzI1NiIs..."
      responses:
        '200':
          description: 토큰 갱신 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/auth/logout:
    post:
      tags: [Auth]
      summary: 로그아웃
      description: Refresh token 무효화
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [refresh_token]
              properties:
                refresh_token:
                  type: string
                  example: "eyJhbGciOiJIUzI1NiIs..."
      responses:
        '200':
          description: 로그아웃 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'

  /api/auth/send-code:
    post:
      tags: [Auth]
      summary: 인증코드 발송
      description: 이메일로 인증코드 발송
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email]
              properties:
                email:
                  type: string
                  format: email
                  example: "user@example.com"
      responses:
        '200':
          description: 인증코드 발송 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '400':
          $ref: '#/components/responses/BadRequest'

  # ============================================
  # Auth APIs (Protected - 로그인 필요)
  # ============================================
  /api/auth/me:
    get:
      tags: [Auth]
      summary: 내 정보 조회
      description: 현재 로그인한 사용자 정보 조회
      security:
        - BearerAuth: []
      responses:
        '200':
          description: 사용자 정보
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/auth/link-email:
    post:
      tags: [Auth]
      summary: 이메일 연동
      description: 게스트 계정에 이메일 연동
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password, code]
              properties:
                email:
                  type: string
                  format: email
                  example: "user@example.com"
                password:
                  type: string
                  format: password
                  example: "password123"
                code:
                  type: string
                  description: 이메일 인증 코드
                  example: "123456"
      responses:
        '200':
          description: 이메일 연동 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '409':
          description: 이메일 중복
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/auth/change-password:
    post:
      tags: [Auth]
      summary: 비밀번호 변경
      description: 현재 비밀번호 확인 후 새 비밀번호로 변경
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [old_password, new_password]
              properties:
                old_password:
                  type: string
                  format: password
                  example: "oldpassword123"
                new_password:
                  type: string
                  format: password
                  example: "newpassword456"
      responses:
        '200':
          description: 비밀번호 변경 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT access token

  schemas:
    SuccessResponse:
      type: object
      properties:
        status:
          type: string
          example: "OK"
        message:
          type: string
          example: "success"

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          example: "error message"

    MessageResponse:
      type: object
      properties:
        message:
          type: string
          example: "operation successful"

    TokenResponse:
      type: object
      properties:
        access_token:
          type: string
          example: "eyJhbGciOiJIUzI1NiIs..."
        refresh_token:
          type: string
          example: "eyJhbGciOiJIUzI1NiIs..."
        expires_in:
          type: integer
          description: Access token 만료 시간 (초)
          example: 3600

    UserResponse:
      type: object
      properties:
        id:
          type: integer
          format: int64
          example: 1
        email:
          type: string
          format: email
          example: "user@example.com"
        is_guest:
          type: boolean
          example: false
        created_at:
          type: string
          format: date-time

  responses:
    BadRequest:
      description: 잘못된 요청
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    Unauthorized:
      description: 인증 실패
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    ServiceUnavailable:
      description: 서버 과부하
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
