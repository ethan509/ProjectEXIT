openapi: 3.0.3
info:
  title: LottoSmash API
  description: LottoSmash 서버 API 명세
  version: 1.0.0

servers:
  - url: http://localhost:8081
    description: Local development server

tags:
  - name: System
    description: 시스템 상태 확인
  - name: Example
    description: 예제 API
  - name: Auth
    description: 인증 관련 API
  - name: Lotto
    description: 로또 당첨번호 및 통계 API

paths:
  # ============================================
  # System APIs
  # ============================================
  /healthz:
    get:
      tags: [System]
      summary: 서버 상태 확인
      description: 서버가 살아있는지 확인
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'

  /readyz:
    get:
      tags: [System]
      summary: 서버 준비 상태 확인
      description: 서버가 요청을 처리할 준비가 되었는지 확인
      responses:
        '200':
          description: Ready
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'

  /metrics:
    get:
      tags: [System]
      summary: Prometheus 메트릭
      description: Prometheus 형식의 메트릭 데이터
      responses:
        '200':
          description: Metrics data
          content:
            text/plain:
              schema:
                type: string

  # ============================================
  # Example APIs
  # ============================================
  /api/v1/ping:
    get:
      tags: [Example]
      summary: Ping 테스트
      description: 서버 연결 테스트용 ping
      responses:
        '200':
          description: Pong
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          now:
                            type: string
                            format: date-time

  /api/v1/echo:
    post:
      tags: [Example]
      summary: Echo 테스트
      description: 요청 메시지를 그대로 반환
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [message]
              properties:
                message:
                  type: string
                  example: "Hello, World!"
      responses:
        '200':
          description: Echo response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '503':
          $ref: '#/components/responses/ServiceUnavailable'

  # ============================================
  # Auth APIs (Public)
  # ============================================
  /api/auth/guest:
    post:
      tags: [Auth]
      summary: 게스트 로그인
      description: 디바이스 ID로 게스트 계정 생성 및 로그인
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [device_id]
              properties:
                device_id:
                  type: string
                  example: "device-uuid-1234"
      responses:
        '200':
          description: 로그인 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '400':
          $ref: '#/components/responses/BadRequest'

  /api/auth/register:
    post:
      tags: [Auth]
      summary: 이메일 회원가입
      description: 이메일 인증 후 회원가입
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password, code]
              properties:
                email:
                  type: string
                  format: email
                  example: "user@example.com"
                password:
                  type: string
                  format: password
                  example: "password123"
                code:
                  type: string
                  description: 이메일 인증 코드
                  example: "123456"
      responses:
        '201':
          description: 회원가입 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          description: 이메일 중복
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/auth/login:
    post:
      tags: [Auth]
      summary: 이메일 로그인
      description: 이메일과 비밀번호로 로그인
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email:
                  type: string
                  format: email
                  example: "user@example.com"
                password:
                  type: string
                  format: password
                  example: "password123"
      responses:
        '200':
          description: 로그인 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/auth/refresh:
    post:
      tags: [Auth]
      summary: 토큰 갱신
      description: Refresh token으로 새로운 access token 발급
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [refresh_token]
              properties:
                refresh_token:
                  type: string
                  example: "eyJhbGciOiJIUzI1NiIs..."
      responses:
        '200':
          description: 토큰 갱신 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/auth/logout:
    post:
      tags: [Auth]
      summary: 로그아웃
      description: Refresh token 무효화
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [refresh_token]
              properties:
                refresh_token:
                  type: string
                  example: "eyJhbGciOiJIUzI1NiIs..."
      responses:
        '200':
          description: 로그아웃 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'

  /api/auth/send-code:
    post:
      tags: [Auth]
      summary: 인증코드 발송
      description: 이메일로 인증코드 발송
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email]
              properties:
                email:
                  type: string
                  format: email
                  example: "user@example.com"
      responses:
        '200':
          description: 인증코드 발송 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '400':
          $ref: '#/components/responses/BadRequest'

  # ============================================
  # Auth APIs (Protected - 로그인 필요)
  # ============================================
  /api/auth/me:
    get:
      tags: [Auth]
      summary: 내 정보 조회
      description: 현재 로그인한 사용자 정보 조회
      security:
        - BearerAuth: []
      responses:
        '200':
          description: 사용자 정보
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/auth/link-email:
    post:
      tags: [Auth]
      summary: 이메일 연동
      description: 게스트 계정에 이메일 연동
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password, code]
              properties:
                email:
                  type: string
                  format: email
                  example: "user@example.com"
                password:
                  type: string
                  format: password
                  example: "password123"
                code:
                  type: string
                  description: 이메일 인증 코드
                  example: "123456"
      responses:
        '200':
          description: 이메일 연동 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '409':
          description: 이메일 중복
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/auth/change-password:
    post:
      tags: [Auth]
      summary: 비밀번호 변경
      description: 현재 비밀번호 확인 후 새 비밀번호로 변경
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [old_password, new_password]
              properties:
                old_password:
                  type: string
                  format: password
                  example: "oldpassword123"
                new_password:
                  type: string
                  format: password
                  example: "newpassword456"
      responses:
        '200':
          description: 비밀번호 변경 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  # ============================================
  # Lotto APIs
  # ============================================
  /api/lotto/draws:
    get:
      tags: [Lotto]
      summary: 당첨번호 목록 조회
      description: 로또 당첨번호 목록을 페이지네이션으로 조회
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            maximum: 100
          description: 조회할 개수 (최대 100)
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
          description: 건너뛸 개수
      responses:
        '200':
          description: 당첨번호 목록
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DrawListResponse'

  /api/lotto/draws/{drawNo}:
    get:
      tags: [Lotto]
      summary: 특정 회차 당첨번호 조회
      description: 특정 회차의 당첨번호 상세 정보 조회
      parameters:
        - name: drawNo
          in: path
          required: true
          schema:
            type: integer
          description: 회차 번호
          example: 1000
      responses:
        '200':
          description: 당첨번호 정보
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LottoDraw'
        '404':
          description: 회차를 찾을 수 없음
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/lotto/stats:
    get:
      tags: [Lotto]
      summary: 전체 통계 조회
      description: 번호별 당첨 횟수 및 재등장 확률 통계
      responses:
        '200':
          description: 통계 정보
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatsResponse'

  /api/lotto/stats/numbers:
    get:
      tags: [Lotto]
      summary: 번호별 당첨 횟수
      description: 1~45 각 번호별 당첨 횟수 통계
      responses:
        '200':
          description: 번호별 통계
          content:
            application/json:
              schema:
                type: object
                properties:
                  number_stats:
                    type: array
                    items:
                      $ref: '#/components/schemas/NumberStat'

  /api/lotto/stats/reappear:
    get:
      tags: [Lotto]
      summary: 번호 재등장 확률
      description: 각 번호가 다음 회차에 재등장할 확률 통계
      responses:
        '200':
          description: 재등장 확률 통계
          content:
            application/json:
              schema:
                type: object
                properties:
                  reappear_stats:
                    type: array
                    items:
                      $ref: '#/components/schemas/ReappearStat'

  /api/admin/lotto/sync:
    post:
      tags: [Lotto]
      summary: 수동 동기화 (관리자)
      description: 최신 당첨번호를 수동으로 동기화
      security:
        - BearerAuth: []
      responses:
        '200':
          description: 동기화 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT access token

  schemas:
    SuccessResponse:
      type: object
      properties:
        status:
          type: string
          example: "OK"
        message:
          type: string
          example: "success"

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          example: "error message"

    MessageResponse:
      type: object
      properties:
        message:
          type: string
          example: "operation successful"

    TokenResponse:
      type: object
      properties:
        access_token:
          type: string
          example: "eyJhbGciOiJIUzI1NiIs..."
        refresh_token:
          type: string
          example: "eyJhbGciOiJIUzI1NiIs..."
        expires_in:
          type: integer
          description: Access token 만료 시간 (초)
          example: 3600

    UserResponse:
      type: object
      properties:
        id:
          type: integer
          format: int64
          example: 1
        email:
          type: string
          format: email
          example: "user@example.com"
        is_guest:
          type: boolean
          example: false
        created_at:
          type: string
          format: date-time

    LottoDraw:
      type: object
      properties:
        id:
          type: integer
          format: int64
        draw_no:
          type: integer
          description: 회차 번호
          example: 1000
        draw_date:
          type: string
          format: date
          description: 추첨일
          example: "2022-01-01"
        num1:
          type: integer
          description: 당첨번호 1
          example: 7
        num2:
          type: integer
          example: 13
        num3:
          type: integer
          example: 21
        num4:
          type: integer
          example: 28
        num5:
          type: integer
          example: 35
        num6:
          type: integer
          example: 42
        bonus_num:
          type: integer
          description: 보너스 번호
          example: 15
        first_prize:
          type: integer
          format: int64
          description: 1등 당첨금
          example: 2000000000
        first_winners:
          type: integer
          description: 1등 당첨자 수
          example: 5

    DrawListResponse:
      type: object
      properties:
        draws:
          type: array
          items:
            $ref: '#/components/schemas/LottoDraw'
        total_count:
          type: integer
          description: 전체 회차 수
        latest_draw:
          type: integer
          description: 최신 회차 번호

    NumberStat:
      type: object
      properties:
        number:
          type: integer
          description: 번호 (1~45)
          example: 7
        total_count:
          type: integer
          description: 총 당첨 횟수
          example: 150
        bonus_count:
          type: integer
          description: 보너스로 나온 횟수
          example: 25
        last_draw_no:
          type: integer
          description: 마지막으로 나온 회차
          example: 1150

    ReappearStat:
      type: object
      properties:
        number:
          type: integer
          description: 번호 (1~45)
          example: 7
        total_appear:
          type: integer
          description: 총 출현 횟수
          example: 150
        reappear_count:
          type: integer
          description: 다음 회차에 재등장한 횟수
          example: 25
        probability:
          type: number
          format: float
          description: 재등장 확률
          example: 0.1667

    StatsResponse:
      type: object
      properties:
        number_stats:
          type: array
          items:
            $ref: '#/components/schemas/NumberStat'
        reappear_stats:
          type: array
          items:
            $ref: '#/components/schemas/ReappearStat'
        latest_draw_no:
          type: integer
          description: 기준 회차
        calculated_at:
          type: string
          format: date-time
          description: 계산 시점

  responses:
    BadRequest:
      description: 잘못된 요청
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    Unauthorized:
      description: 인증 실패
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    ServiceUnavailable:
      description: 서버 과부하
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
